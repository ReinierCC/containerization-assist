name: Individual Tool Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "22"

jobs:
  # Test prepare-cluster + push-image tools with local registry
  test-local-registry:
    name: Local Registry & Push (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      matrix:
        os: [ubuntu-latest] # macOS doesn't support nested virtualization needed for kind currently
      fail-fast: false
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install tsx
        run: npm install -g tsx

      - name: Setup Docker and Kind (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install colima
          brew install kind
          brew install docker
          colima start --cpu 2 --memory 4
          docker context use colima

      - name: Install Docker and Kind (linux)
        if: runner.os == 'Linux'
        run: |
          # Install Docker
          sudo apt-get update
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/
          kind version

      - name: Verify Docker installation
        run: |
          echo "=== Docker version and info ==="
          docker --version
          docker info

          echo "=== Docker containers ==="
          docker ps -a

      - name: Read platform and set TARGET_PLATFORM
        run: |
          if [ "$(uname -m)" == "x86_64" ]; then
            echo "TARGET_PLATFORM=linux/amd64" >> $GITHUB_ENV
          elif [ "$(uname -m)" == "arm64" ] || [ "$(uname -m)" == "aarch64" ]; then
            echo "TARGET_PLATFORM=linux/arm64" >> $GITHUB_ENV
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi

          echo "Detected architecture: $(uname -m), set TARGET_PLATFORM=$TARGET_PLATFORM"
      - name: Run local registry integration test
        env:
          TARGET_PLATFORM: ${{ env.TARGET_PLATFORM }}
        run: |
          tsx scripts/integration-test-local-registry.ts
        timeout-minutes: 10

      - name: Show pod status on failure
        if: failure()
        run: |
          echo "=== Pods ==="
          kubectl get pods -A || true
          echo ""
          echo "=== Pod description ==="
          kubectl describe pod test-registry-pod || true
          echo ""
          echo "=== Pod events ==="
          kubectl get events --sort-by=.lastTimestamp || true

      - name: Cleanup
        if: always()
        run: |
          kubectl delete pod test-registry-pod --ignore-not-found=true || true
          kind delete cluster --name containerization-assist || true
          docker rm -f ca-registry || true

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a || true
          echo ""
          echo "=== Registry logs ==="
          docker logs ca-registry || true
          echo ""
          echo "=== Kind clusters ==="
          kind get clusters || true
          echo ""
          echo "=== kubectl version ==="
          kubectl version || true

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸ§ª Individual Tool Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Local Registry & Push Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tools Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`prepare-cluster\` - Creates kind cluster with local registry" >> $GITHUB_STEP_SUMMARY
          echo "- \`push-image\` - Pushes image to local registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Flow" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Create kind cluster with local registry" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Verify registry is healthy and reachable from cluster" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Build test image (busybox)" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… Push image to local registry" >> $GITHUB_STEP_SUMMARY
          echo "5. âœ… Verify image in registry catalog" >> $GITHUB_STEP_SUMMARY
          echo "6. âœ… Deploy pod using \`localhost:PORT/image\` format" >> $GITHUB_STEP_SUMMARY
          echo "7. âœ… Verify pod pulls image successfully" >> $GITHUB_STEP_SUMMARY
          echo "8. âœ… Verify pod executes successfully" >> $GITHUB_STEP_SUMMARY

  # Test policy enforcement with fix-dockerfile
  test-policy-enforcement:
    name: fix-dockerfile Policy Enforcement Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install tsx
        run: npm install -g tsx

      - name: Install OPA CLI
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/opa
          opa version

      - name: Verify test fixtures
        run: |
          echo "Verifying test fixtures exist..."
          ls -la test/fixtures/policy-validation/happy/
          ls -la test/fixtures/policy-validation/sad/
          echo "âœ… All test fixtures found"

      - name: Run policy enforcement tests
        id: policy-tests
        run: |
          tsx scripts/test-policy-enforcement.ts
        timeout-minutes: 5

      - name: Display test results
        if: always()
        run: |
          if [ -f "policy-test-results.json" ]; then
            echo "=== Test Results ==="
            cat policy-test-results.json
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ Policy Enforcement Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tool Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`fix-dockerfile\` - Validates Dockerfiles against built-in Rego policies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "policy-test-results.json" ]; then
            TOTAL=$(jq -r '.total' policy-test-results.json)
            PASSED=$(jq -r '.passed' policy-test-results.json)
            FAILED=$(jq -r '.failed' policy-test-results.json)
            TOTAL_RULES=$(jq -r '.coverage.totalRules' policy-test-results.json)
            COVERED_RULES=$(jq -r '.coverage.coveredRules' policy-test-results.json)
            MISSING_RULES=$(jq -r '.coverage.missingRules' policy-test-results.json)
            
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: âœ… $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Coverage" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Policy Rules**: $TOTAL_RULES" >> $GITHUB_STEP_SUMMARY
            echo "- **Rules with Tests**: âœ… $COVERED_RULES" >> $GITHUB_STEP_SUMMARY
            echo "- **Rules Missing Tests**: $(if [ "$MISSING_RULES" -eq "0" ]; then echo "âœ… 0"; else echo "âŒ $MISSING_RULES"; fi)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.policy-tests.outcome }}" = "success" ]; then
              echo "### âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Dynamically generate test coverage from JSON
            echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            BLOCKING_COUNT=$(jq -r '.coverage.blockingRules' policy-test-results.json)
            echo "### Blocking Violations ($BLOCKING_COUNT rules)" >> $GITHUB_STEP_SUMMARY
            jq -r '.coverage.blockingRuleDetails[] | "- " + (if .tested then "âœ…" else "âŒ" end) + " `" + .ruleId + "`"' policy-test-results.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            WARNING_COUNT=$(jq -r '.coverage.warningRules' policy-test-results.json)
            echo "### Warnings ($WARNING_COUNT rules)" >> $GITHUB_STEP_SUMMARY
            jq -r '.coverage.warningRuleDetails[] | "- " + (if .tested then "âš ï¸" else "âŒ" end) + " `" + .ruleId + "`"' policy-test-results.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## Policies Tested" >> $GITHUB_STEP_SUMMARY
            jq -r '.coverage.policyFiles[] | "- `policies/" + . + "`"' policy-test-results.json >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: policy-test-results
          path: policy-test-results.json
          retention-days: 7
