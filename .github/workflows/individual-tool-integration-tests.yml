name: Individual Tool Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "22"

jobs:
  # Test prepare-cluster + push-image tools with local registry
  test-local-registry:
    name: Local Registry & Push (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      matrix:
        os: [ubuntu-latest] # macOS doesn't support nested virtualization needed for kind currently
      fail-fast: false
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install tsx
        run: npm install -g tsx

      - name: Setup Docker and Kind (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install colima
          brew install kind
          brew install docker
          colima start --cpu 2 --memory 4
          docker context use colima

      - name: Install Docker and Kind (linux)
        if: runner.os == 'Linux'
        run: |
          # Install Docker
          sudo apt-get update
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/
          kind version

      - name: Verify Docker installation
        run: |
          echo "=== Docker version and info ==="
          docker --version
          docker info

          echo "=== Docker containers ==="
          docker ps -a

      - name: Read platform and set TARGET_PLATFORM
        run: |
          if [ "$(uname -m)" == "x86_64" ]; then
            echo "TARGET_PLATFORM=linux/amd64" >> $GITHUB_ENV
          elif [ "$(uname -m)" == "arm64" ] || [ "$(uname -m)" == "aarch64" ]; then
            echo "TARGET_PLATFORM=linux/arm64" >> $GITHUB_ENV
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi

          echo "Detected architecture: $(uname -m), set TARGET_PLATFORM=$TARGET_PLATFORM"
      - name: Run local registry integration test
        env:
          TARGET_PLATFORM: ${{ env.TARGET_PLATFORM }}
        run: |
          tsx scripts/integration-test-local-registry.ts
        timeout-minutes: 10

      - name: Show pod status on failure
        if: failure()
        run: |
          echo "=== Pods ==="
          kubectl get pods -A || true
          echo ""
          echo "=== Pod description ==="
          kubectl describe pod test-registry-pod || true
          echo ""
          echo "=== Pod events ==="
          kubectl get events --sort-by=.lastTimestamp || true

      - name: Cleanup
        if: always()
        run: |
          kubectl delete pod test-registry-pod --ignore-not-found=true || true
          kind delete cluster --name containerization-assist || true
          docker rm -f ca-registry || true

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a || true
          echo ""
          echo "=== Registry logs ==="
          docker logs ca-registry || true
          echo ""
          echo "=== Kind clusters ==="
          kind get clusters || true
          echo ""
          echo "=== kubectl version ==="
          kubectl version || true

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸ§ª Individual Tool Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Local Registry & Push Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tools Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`prepare-cluster\` - Creates kind cluster with local registry" >> $GITHUB_STEP_SUMMARY
          echo "- \`push-image\` - Pushes image to local registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Flow" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Create kind cluster with local registry" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Verify registry is healthy and reachable from cluster" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Build test image (busybox)" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… Push image to local registry" >> $GITHUB_STEP_SUMMARY
          echo "5. âœ… Verify image in registry catalog" >> $GITHUB_STEP_SUMMARY
          echo "6. âœ… Deploy pod using \`localhost:PORT/image\` format" >> $GITHUB_STEP_SUMMARY
          echo "7. âœ… Verify pod pulls image successfully" >> $GITHUB_STEP_SUMMARY
          echo "8. âœ… Verify pod executes successfully" >> $GITHUB_STEP_SUMMARY

  # Test policy enforcement with fix-dockerfile
  test-policy-enforcement:
    name: fix-dockerfile Policy Enforcement Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install tsx
        run: npm install -g tsx

      - name: Install OPA CLI
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/opa
          opa version

      - name: Verify test fixtures
        run: |
          echo "Verifying test fixtures exist..."
          ls -la test/fixtures/policy-validation/happy/
          ls -la test/fixtures/policy-validation/sad/
          echo "âœ… All test fixtures found"

      - name: Run policy enforcement tests
        id: policy-tests
        run: |
          tsx scripts/test-policy-enforcement.ts
        timeout-minutes: 5

      - name: Display test results
        if: always()
        run: |
          if [ -f "policy-test-results.json" ]; then
            echo "=== Test Results ==="
            cat policy-test-results.json
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ Policy Enforcement Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tool Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`fix-dockerfile\` - Validates Dockerfiles against built-in Rego policies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "policy-test-results.json" ]; then
            TOTAL=$(jq -r '.total' policy-test-results.json)
            PASSED=$(jq -r '.passed' policy-test-results.json)
            FAILED=$(jq -r '.failed' policy-test-results.json)
            TOTAL_RULES=$(jq -r '.coverage.totalRules' policy-test-results.json)
            COVERED_RULES=$(jq -r '.coverage.coveredRules' policy-test-results.json)
            MISSING_RULES=$(jq -r '.coverage.missingRules' policy-test-results.json)
            
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: âœ… $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Coverage" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Policy Rules**: $TOTAL_RULES" >> $GITHUB_STEP_SUMMARY
            echo "- **Rules with Tests**: âœ… $COVERED_RULES" >> $GITHUB_STEP_SUMMARY
            echo "- **Rules Missing Tests**: $(if [ "$MISSING_RULES" -eq "0" ]; then echo "âœ… 0"; else echo "âŒ $MISSING_RULES"; fi)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.policy-tests.outcome }}" = "success" ]; then
              echo "### âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Dynamically generate test coverage from JSON
            echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            BLOCKING_COUNT=$(jq -r '.coverage.blockingRules' policy-test-results.json)
            echo "### Blocking Violations ($BLOCKING_COUNT rules)" >> $GITHUB_STEP_SUMMARY
            jq -r '.coverage.blockingRuleDetails[] | "- " + (if .tested then "âœ…" else "âŒ" end) + " `" + .ruleId + "`"' policy-test-results.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            WARNING_COUNT=$(jq -r '.coverage.warningRules' policy-test-results.json)
            echo "### Warnings ($WARNING_COUNT rules)" >> $GITHUB_STEP_SUMMARY
            jq -r '.coverage.warningRuleDetails[] | "- " + (if .tested then "âš ï¸" else "âŒ" end) + " `" + .ruleId + "`"' policy-test-results.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## Policies Tested" >> $GITHUB_STEP_SUMMARY
            jq -r '.coverage.policyFiles[] | "- `policies/" + . + "`"' policy-test-results.json >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: policy-test-results
          path: policy-test-results.json
          retention-days: 7

  # Test scan-image with real security scanners (Trivy)
  test-scan-image:
    name: scan-image Security Scanner Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install tsx
        run: npm install -g tsx

      - name: Install Trivy
        run: |
          # Install Trivy using official installation script
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Update Trivy vulnerability database
        run: |
          # Download the vulnerability database before scanning
          trivy image --download-db-only
          echo "âœ… Trivy database updated"

      - name: Run scan-image integration test
        id: scan-tests
        run: |
          tsx scripts/integration-test-scan-image.ts
        timeout-minutes: 15

      - name: Show test results on failure
        if: failure()
        run: |
          echo "=== Docker images ==="
          docker images || true
          echo ""
          echo "=== Test results ==="
          if [ -f "scan-image-test-results.json" ]; then
            cat scan-image-test-results.json
          fi

      - name: Cleanup Docker images
        if: always()
        run: |
          docker rmi -f test-scan:java-vulns test-scan:dotnet-vulns test-scan:clean || true
          docker rmi -f openjdk:8u181-jdk mcr.microsoft.com/dotnet/aspnet:3.1 mcr.microsoft.com/dotnet/runtime:8.0-alpine || true

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸ”’ Security Scanner Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tool Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`scan-image\` - Scans Docker images for vulnerabilities using Trivy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "scan-image-test-results.json" ]; then
            TOTAL=$(jq -r '.total' scan-image-test-results.json)
            PASSED=$(jq -r '.passed' scan-image-test-results.json)
            FAILED=$(jq -r '.failed' scan-image-test-results.json)
            
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: âœ… $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## Test Cases" >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | "- " + (if .passed then "âœ…" else "âŒ" end) + " **" + .name + "**" + (if .vulnerabilities then " (C:" + (.vulnerabilities.critical|tostring) + " H:" + (.vulnerabilities.high|tostring) + " M:" + (.vulnerabilities.medium|tostring) + ")" else "" end)' scan-image-test-results.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.scan-tests.outcome }}" = "success" ]; then
              echo "### âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Failed test details:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.results[] | select(.passed == false) | "- **" + .name + "**: " + .message' scan-image-test-results.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Images (Pulled from Registries)" >> $GITHUB_STEP_SUMMARY
          echo "- \`openjdk:8u181-jdk\`: Java OpenJDK 8 (2018) with known CVEs" >> $GITHUB_STEP_SUMMARY
          echo "- \`mcr.microsoft.com/dotnet/aspnet:3.1\`: .NET Core 3.1 (EOL Dec 2022)" >> $GITHUB_STEP_SUMMARY
          echo "- \`mcr.microsoft.com/dotnet/runtime:8.0-alpine\`: Clean .NET 8 baseline" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: scan-image-test-results
          path: scan-image-test-results.json
          retention-days: 7

  # Test tag-image with various tagging scenarios
  test-tag-image:
    name: tag-image Docker Tagging Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install tsx
        run: npm install -g tsx

      - name: Verify Docker
        run: |
          docker --version
          docker info

      - name: Run tag-image integration test
        id: tag-tests
        run: |
          tsx scripts/integration-test-tag-image.ts
        timeout-minutes: 5

      - name: Cleanup Docker images
        if: always()
        run: |
          docker images --format "{{.Repository}}:{{.Tag}}" | grep test-tag-image | xargs -r docker rmi -f || true

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸ·ï¸ Docker Tagging Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tool Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`tag-image\` - Tags Docker images with version and registry information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "tag-image-test-results.json" ]; then
            TOTAL=$(jq -r '.total' tag-image-test-results.json)
            PASSED=$(jq -r '.passed' tag-image-test-results.json)
            FAILED=$(jq -r '.failed' tag-image-test-results.json)
            
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: âœ… $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## Test Cases" >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | "- " + (if .passed then "âœ…" else "âŒ" end) + " **" + .name + "**"' tag-image-test-results.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.tag-tests.outcome }}" = "success" ]; then
              echo "### âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Failed test details:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.results[] | select(.passed == false) | "- **" + .name + "**: " + .message' tag-image-test-results.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tag Formats Tested" >> $GITHUB_STEP_SUMMARY
          echo "- Simple version tags (\`v1.0.0\`)" >> $GITHUB_STEP_SUMMARY
          echo "- Latest tag" >> $GITHUB_STEP_SUMMARY
          echo "- Git SHA tags (\`sha-abc1234\`)" >> $GITHUB_STEP_SUMMARY
          echo "- Environment + date tags (\`staging-2024.01.15\`)" >> $GITHUB_STEP_SUMMARY
          echo "- Registry URL prefixed tags" >> $GITHUB_STEP_SUMMARY
          echo "- Nested repository paths" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: tag-image-test-results
          path: tag-image-test-results.json
          retention-days: 7

  # Test verify-deploy with real Kubernetes deployments
  test-verify-deploy:
    name: verify-deploy Kubernetes Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install tsx
        run: npm install -g tsx

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/
          kind version

      - name: Read platform and set TARGET_PLATFORM
        run: |
          if [ "$(uname -m)" == "x86_64" ]; then
            echo "TARGET_PLATFORM=linux/amd64" >> $GITHUB_ENV
          elif [ "$(uname -m)" == "arm64" ] || [ "$(uname -m)" == "aarch64" ]; then
            echo "TARGET_PLATFORM=linux/arm64" >> $GITHUB_ENV
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi

      - name: Verify test fixtures
        run: |
          echo "Verifying test fixtures exist..."
          ls -la test/fixtures/kubernetes-deployments/
          ls -la test/fixtures/kubernetes-deployments/health-check-app/
          cat test/fixtures/kubernetes-deployments/simple-web-app.yaml
          echo "âœ… All test fixtures found"

      - name: Run verify-deploy integration test
        id: verify-tests
        env:
          TARGET_PLATFORM: ${{ env.TARGET_PLATFORM }}
        run: |
          tsx scripts/integration-test-verify-deploy.ts
        timeout-minutes: 15

      - name: Show debug info on failure
        if: failure()
        run: |
          echo "=== Kind clusters ==="
          kind get clusters || true
          echo ""
          echo "=== Pods ==="
          kubectl get pods -A || true
          echo ""
          echo "=== Pod description ==="
          kubectl describe pods -l app=test-web-app || true
          echo ""
          echo "=== Docker containers ==="
          docker ps -a || true
          echo ""
          echo "=== Registry logs ==="
          docker logs ca-registry 2>&1 | tail -50 || true

      - name: Cleanup
        if: always()
        run: |
          kubectl delete deployment test-web-app --ignore-not-found=true || true
          kubectl delete service test-web-app --ignore-not-found=true || true
          kind delete cluster --name containerization-assist || true
          docker rm -f ca-registry || true

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸš€ Kubernetes Deployment Verification Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tool Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`verify-deploy\` - Verifies Kubernetes deployment health and endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "verify-deploy-test-results.json" ]; then
            TOTAL=$(jq -r '.total' verify-deploy-test-results.json)
            PASSED=$(jq -r '.passed' verify-deploy-test-results.json)
            FAILED=$(jq -r '.failed' verify-deploy-test-results.json)
            PLATFORM=$(jq -r '.platform' verify-deploy-test-results.json)
            
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: âœ… $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- **Platform**: $PLATFORM" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## Test Steps" >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | "- " + (if .passed then "âœ…" else "âŒ" end) + " **" + .name + "**"' verify-deploy-test-results.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.verify-tests.outcome }}" = "success" ]; then
              echo "### âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Failed step details:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.results[] | select(.passed == false) | "- **" + .name + "**: " + .message' verify-deploy-test-results.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Flow" >> $GITHUB_STEP_SUMMARY
          echo "1. Create kind cluster with local registry" >> $GITHUB_STEP_SUMMARY
          echo "2. Build health check application" >> $GITHUB_STEP_SUMMARY
          echo "3. Push to local registry" >> $GITHUB_STEP_SUMMARY
          echo "4. Deploy to Kubernetes (2 replicas)" >> $GITHUB_STEP_SUMMARY
          echo "5. Wait for deployment ready" >> $GITHUB_STEP_SUMMARY
          echo "6. Run verify-deploy tool" >> $GITHUB_STEP_SUMMARY
          echo "7. Validate health checks and endpoints" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: verify-deploy-test-results
          path: verify-deploy-test-results.json
          retention-days: 7

  # Test build-image with multi-language scenarios
  test-build-image:
    name: build-image Multi-Language Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install tsx
        run: npm install -g tsx

      - name: Verify Docker
        run: |
          docker --version
          docker info

      - name: Verify test fixtures
        run: |
          echo "Verifying test fixtures exist..."
          ls -la test/fixtures/build-scenarios/
          ls -la test/fixtures/build-scenarios/java/
          ls -la test/fixtures/build-scenarios/dotnet/
          echo "âœ… All test fixtures found"

      - name: Run build-image integration test
        id: build-tests
        run: |
          tsx scripts/integration-test-build-image.ts
        timeout-minutes: 15

      - name: Cleanup Docker images
        if: always()
        run: |
          docker images --format "{{.Repository}}:{{.Tag}}" | grep test-build | xargs -r docker rmi -f || true

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸ”¨ Multi-Language Build Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tool Tested" >> $GITHUB_STEP_SUMMARY
          echo "- \`build-image\` - Builds Docker images from Dockerfiles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "build-image-test-results.json" ]; then
            TOTAL=$(jq -r '.total' build-image-test-results.json)
            PASSED=$(jq -r '.passed' build-image-test-results.json)
            FAILED=$(jq -r '.failed' build-image-test-results.json)
            
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: âœ… $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## Test Cases" >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | "- " + (if .passed then "âœ…" else "âŒ" end) + " **" + .name + "**" + (if .imageSize then " (" + ((.imageSize / 1000000) | floor | tostring) + "MB)" else "" end)' build-image-test-results.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.build-tests.outcome }}" = "success" ]; then
              echo "### âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Failed test details:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.results[] | select(.passed == false) | "- **" + .name + "**: " + .message' build-image-test-results.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Languages Tested" >> $GITHUB_STEP_SUMMARY
          echo "- **Java**: Multi-stage build with Eclipse Temurin JRE" >> $GITHUB_STEP_SUMMARY
          echo "- **.NET**: Multi-stage build with ASP.NET 8 runtime" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Features Tested" >> $GITHUB_STEP_SUMMARY
          echo "- Multi-stage builds" >> $GITHUB_STEP_SUMMARY
          echo "- Build argument injection" >> $GITHUB_STEP_SUMMARY
          echo "- Image size validation" >> $GITHUB_STEP_SUMMARY
          echo "- Layer count validation" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: build-image-test-results
          path: build-image-test-results.json
          retention-days: 7

  # Complete E2E Workflow Test - Tests entire containerization pipeline
  test-e2e-workflow:
    name: Complete E2E Workflow Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install tsx
        run: npm install -g tsx

      - name: Install kind and kubectl
        run: |
          # Install kind
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/
          kind version
          
          # kubectl is usually pre-installed on ubuntu-latest
          kubectl version --client || true

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
          trivy --version

      - name: Verify Docker
        run: |
          docker --version
          docker info

      - name: Verify test fixtures
        run: |
          echo "Verifying test fixtures exist..."
          ls -la test/fixtures/complete-workflow/
          ls -la test/fixtures/complete-workflow/sample-app/
          ls -la test/fixtures/complete-workflow/kubernetes/
          echo "âœ… All test fixtures found"

      - name: Run E2E workflow integration test
        id: e2e-tests
        run: |
          tsx scripts/integration-test-complete-workflow.ts
        timeout-minutes: 25

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "Cleaning up resources..."
          kind delete cluster --name containerization-assist || true
          docker rm -f ca-registry || true
          docker images --format "{{.Repository}}:{{.Tag}}" | grep sample-workflow | xargs -r docker rmi -f || true
          echo "Cleanup complete"

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸŽ¯ Complete E2E Workflow Integration Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Workflow Pipeline Tested" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "analyze-repo â†’ generate-dockerfile â†’ build-image â†’ scan-image" >> $GITHUB_STEP_SUMMARY
          echo "    â†’ tag-image â†’ prepare-cluster â†’ push-image â†’ deploy â†’ verify-deploy" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "e2e-workflow-test-results.json" ]; then
            TOTAL=$(jq -r '.total' e2e-workflow-test-results.json)
            PASSED=$(jq -r '.passed' e2e-workflow-test-results.json)
            FAILED=$(jq -r '.failed' e2e-workflow-test-results.json)
            DURATION=$(jq -r '.totalDuration' e2e-workflow-test-results.json)
            DURATION_SEC=$((DURATION / 1000))
            
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Steps**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: âœ… $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: âŒ $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- **Duration**: ${DURATION_SEC}s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## Step Results" >> $GITHUB_STEP_SUMMARY
            jq -r '.steps[] | "| Step " + (.step | tostring) + " | " + .tool + " | " + (if .passed then "âœ… Pass" else "âŒ Fail" end) + " | " + ((.duration / 1000) | floor | tostring) + "s |"' e2e-workflow-test-results.json | \
              (echo "| Step | Tool | Status | Duration |"; echo "|------|------|--------|----------|"; cat) >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.e2e-tests.outcome }}" = "success" ]; then
              echo "### ðŸŽ‰ Complete E2E Workflow Passed!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "All 9 tools in the containerization pipeline are working correctly together." >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Workflow Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Failed steps:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.steps[] | select(.passed == false) | "- **Step " + (.step | tostring) + " (" + .tool + ")**: " + .message' e2e-workflow-test-results.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Test results file not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tools Tested" >> $GITHUB_STEP_SUMMARY
          echo "1. **analyze-repo** - Repository analysis" >> $GITHUB_STEP_SUMMARY
          echo "2. **generate-dockerfile** - Dockerfile generation" >> $GITHUB_STEP_SUMMARY
          echo "3. **build-image** - Docker image building" >> $GITHUB_STEP_SUMMARY
          echo "4. **scan-image** - Security vulnerability scanning" >> $GITHUB_STEP_SUMMARY
          echo "5. **prepare-cluster** - Kubernetes cluster setup" >> $GITHUB_STEP_SUMMARY
          echo "6. **tag-image** - Image tagging" >> $GITHUB_STEP_SUMMARY
          echo "7. **push-image** - Registry push" >> $GITHUB_STEP_SUMMARY
          echo "8. **kubectl** - Kubernetes deployment" >> $GITHUB_STEP_SUMMARY
          echo "9. **verify-deploy** - Deployment verification" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: e2e-workflow-test-results
          path: e2e-workflow-test-results.json
          retention-days: 7
