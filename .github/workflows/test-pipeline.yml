name: Test Pipeline

on:
  push:
    branches: [ main, develop, 'feat/**', 'fix/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '22'

jobs:
  # Single test job with all essential validations
  test:
    name: Tests & Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore build cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            dist
            dist-cjs
            .tsbuildinfo
            node_modules/.cache
          key: build-${{ runner.os }}-${{ hashFiles('src/**/*.ts', 'tsconfig*.json', 'package-lock.json') }}
          restore-keys: |
            build-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Install OPA CLI
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x opa
          mkdir -p node_modules/.bin
          mv opa node_modules/.bin/opa
          node_modules/.bin/opa version

      - name: Build project
        run: npm run build

      - name: Test OPA Policies
        run: |
          echo "Testing built-in policies..."
          npm run test:policies 2>&1 | tee policy-tests-builtin.txt

          echo "Testing example policies (including generation-config)..."
          npm run test:policies -- policies.user.examples/ 2>&1 | tee policy-tests-examples.txt

          # Extract test counts
          BUILTIN_COUNT=$(grep -oP '\d+(?=/\d+ PASS)' policy-tests-builtin.txt | tail -1 || echo "0")
          EXAMPLES_COUNT=$(grep -oP '\d+(?=/\d+ PASS)' policy-tests-examples.txt | tail -1 || echo "0")
          TOTAL_POLICY_TESTS=$((BUILTIN_COUNT + EXAMPLES_COUNT))

          echo "POLICY_TESTS_PASSED=${TOTAL_POLICY_TESTS}" >> $GITHUB_ENV
          echo "âœ… All ${TOTAL_POLICY_TESTS} OPA policy tests passed"

      - name: Validate examples compile
        run: node scripts/validate-examples.js

      - name: Run lint and cache output
        run: npm run lint 2>&1 | tee eslint-output.txt || true

      - name: Run tests with coverage
        run: npm run test:coverage -- --passWithNoTests
        env:
          DOCKER_AVAILABLE: true

      - name: Extract coverage metrics
        continue-on-error: true
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            OVERALL=$(jq -r '.total.statements.pct // "N/A"' coverage/coverage-summary.json)
            BRANCHES=$(jq -r '.total.branches.pct // "N/A"' coverage/coverage-summary.json)
            echo "âœ… Coverage: ${OVERALL}% statements, ${BRANCHES}% branches"

            # Save for summary
            echo "COVERAGE_OVERALL=${OVERALL}" >> $GITHUB_ENV
            echo "COVERAGE_BRANCHES=${BRANCHES}" >> $GITHUB_ENV
          else
            echo "âš ï¸ Coverage data not available"
            echo "COVERAGE_OVERALL=N/A" >> $GITHUB_ENV
            echo "COVERAGE_BRANCHES=N/A" >> $GITHUB_ENV
          fi

      - name: Verify build artifacts
        run: |
          test -f dist/src/index.js || { echo "âŒ ESM index.js missing"; exit 1; }
          test -f dist/src/index.d.ts || { echo "âŒ ESM index.d.ts missing"; exit 1; }
          test -x dist/src/cli/cli.js || { echo "âŒ CLI not executable"; exit 1; }
          test -f dist-cjs/src/index.js || { echo "âŒ CJS index.js missing"; exit 1; }
          test -f dist-cjs/src/index.d.ts || { echo "âŒ CJS index.d.ts missing"; exit 1; }

          if grep -r "from ['\"]\.\.\/[^'\"]*['\"]" dist/src --include="*.js" | grep -v "\.js['\"]"; then
            echo "âŒ Found ESM imports without .js extensions"
            exit 1
          fi

          echo "âœ… Build artifacts verified"

      - name: Run quality gates
        run: |
          UPDATE_BASELINES=true npm run quality:gates 2>&1 | tee quality-gates.txt || true

          # Save gate status for summary
          if grep -q "âœ…" quality-gates.txt; then
            echo "QUALITY_STATUS=âœ… Passed" >> $GITHUB_ENV
          elif grep -q "âš ï¸" quality-gates.txt; then
            echo "QUALITY_STATUS=âš ï¸ Warning" >> $GITHUB_ENV
          else
            echo "QUALITY_STATUS=âŒ Failed" >> $GITHUB_ENV
          fi

      - name: Generate workflow summary
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ Test Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Quality Gates** | ${QUALITY_STATUS:-âš ï¸ Unknown} |" >> $GITHUB_STEP_SUMMARY
          echo "| **OPA Policy Tests** | âœ… ${POLICY_TESTS_PASSED:-0} passed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Coverage (Statements)** | ${COVERAGE_OVERALL:-N/A}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Coverage (Branches)** | ${COVERAGE_BRANCHES:-N/A}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "quality-gates.txt" ]; then
            echo "## ðŸ“‹ Quality Gates Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat quality-gates.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Artifacts:** Download \`quality-gates.txt\` for full quality report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Coverage:** Download \`coverage/\` for detailed HTML report" >> $GITHUB_STEP_SUMMARY

      # Upload all artifacts in single step
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: build-and-quality-${{ github.run_id }}
          path: |
            dist/
            dist-cjs/
            quality-gates.txt
            eslint-output.txt
            policy-tests-builtin.txt
            policy-tests-examples.txt
            coverage/
          retention-days: 7

  # Optional security scan (reuses build from test job)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 10
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-and-quality-${{ github.run_id }}
          path: .

      - name: Install dependencies (for audit)
        run: npm ci

      - name: Dependency audit
        run: npm audit --audit-level moderate || true

      - name: CodeQL Analysis
        uses: github/codeql-action/init@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
        with:
          languages: typescript
          queries: security-and-quality
          config-file: ./.github/workflows/codeql/codeql-config.yml

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10